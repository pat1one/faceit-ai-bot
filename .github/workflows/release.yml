name: Release

on:
  push:
    branches:
      - main
      - release
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/release'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Get version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=v$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
          fi
      
      - name: Create releases directory
        run: mkdir -p dist/releases
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/api:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository }}/api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.web
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/web:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository }}/web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Create Docker Compose package
        run: |
          mkdir -p dist/docker
          cp docker-compose.yml dist/docker/
          cp .env.example dist/docker/
          cp README.md dist/docker/
          cd dist/docker
          tar -czf ../faceit-ai-bot-docker-${{ steps.version.outputs.version }}.tar.gz *
      
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ğŸ® Faceit Stats Bot ${{ steps.version.outputs.version }}
          
          ### â¬‡ï¸ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ
          
          #### ğŸ³ Docker
          
          - **Docker Compose**: `faceit-ai-bot-docker-${{ steps.version.outputs.version }}.tar.gz`
          
          ```bash
          # Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ
          tar -xzf faceit-ai-bot-docker-${{ steps.version.outputs.version }}.tar.gz
          cd faceit-ai-bot
          cp .env.example .env
          # ĞÑ‚Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ .env
          docker-compose up -d
          ```
          
          #### ğŸ³ Docker Images
          
          ```bash
          docker pull ghcr.io/${{ github.repository }}/api:${{ steps.version.outputs.version }}
          docker pull ghcr.io/${{ github.repository }}/web:${{ steps.version.outputs.version }}
          ```
          
          ---
          
          **ğŸŒ [Ğ”ĞµĞ¼Ğ¾](https://pattmsc.online)** â€¢ **ğŸ“š [API Docs](https://api.pattmsc.online/docs)** â€¢ **ğŸ“– [Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ](https://github.com/pat1one/faceit-ai-bot)**
          
          **Ğ¡Ğ´ĞµĞ»Ğ°Ğ½Ğ¾ Ñ â¤ï¸ Ğ´Ğ»Ñ CS2 ĞºĞ¾Ğ¼ÑŒÑĞ½Ğ¸Ñ‚Ğ¸**
          EOF
      
      - name: Create or update release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            dist/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload to website
        if: success()
        run: |
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
          mkdir -p website-upload/downloads
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Docker Compose Ğ¿Ğ°ĞºĞµÑ‚
          cp dist/faceit-ai-bot-docker-${{ steps.version.outputs.version }}.tar.gz website-upload/downloads/faceit-ai-bot-docker.tar.gz 2>/dev/null || true
          
          echo "ğŸ“¦ Files prepared for upload to pattmsc.online"
          ls -lah website-upload/downloads/
      
      - name: Upload artifacts for website
        uses: actions/upload-artifact@v4
        with:
          name: website-downloads
          path: website-upload/downloads/
          retention-days: 90
      
      - name: Deploy notification
        run: |
          echo "âœ… Release ${{ steps.version.outputs.version }} created!"
          echo "ğŸ“¦ Docker images pushed to ghcr.io"
          echo "ğŸŒ GitHub: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
          echo "â¬‡ï¸ Downloads ready for pattmsc.online"
